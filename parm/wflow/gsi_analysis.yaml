# This group contains the deterministic GSI task

default_gsi_task: &default_gsi
  account: '&ACCOUNT;'
  attrs:
    cycledefs: #cycledefs_type#
    maxtries: '1'
  envars: &default_envars
    GLOBAL_VAR_DEFNS_FP: '&GLOBAL_VAR_DEFNS_FP;'
    USHdir: '&USHdir;'
    PDY: !cycstr "@Y@m@d"
    cyc: !cycstr "@H"
    subcyc: !cycstr "@M"
    LOGDIR: !cycstr "&LOGDIR;"
    CYCLE_TYPE: '#cycle_type#'
    nprocs: '{{ parent.nnodes * parent.ppn }}'
    SLASH_ENSMEM_SUBDIR: '&SLASH_ENSMEM_SUBDIR;'
  native: '{{ platform.SCHED_NATIVE_CMD }}'
  nodes: '{{ nnodes }}:ppn={{ ppn }}'
  nnodes: 2
  nodesize: "&NCORES_PER_NODE;"
  ppn: 24
  partition: '{% if platform.get("PARTITION_DEFAULT") %}&PARTITION_DEFAULT;{% else %}None{% endif %}'
  queue: '&QUEUE_DEFAULT;'
  walltime: 00:30:00

metatask_analysis_gsi_cycledefs:
  var:
    cycledefs_type: forecast,long_forecast
    cycle_type: prod

  task_prep_cyc_#cycle_type#:
    <<: *default_gsi
    command: '&LOAD_MODULES_RUN_TASK_FP; "analysis_gsi" "&JOBSDIR;/JREGIONAL_PREP_CYCLE"'
    walltime: 00:10:00
    ppn: 1
    nnodes: 1
    join: !cycstr '&LOGDIR;/{{ jobname }}_@Y@m@d@H&LOGEXT;'
    envars:
      <<: *default_envars
    dependency:
      and:
        or:
          timedep: '<cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr>'
          taskdep:
            attrs:
              cycle_offset: '-{{ workflow.DA_CYCLE_INTERVAL_HRS }}:00:00'

  task_analysis_gsi_#cycle_type#:
    <<: *default_gsi
    command: '&LOAD_MODULES_RUN_TASK_FP; "analysis_gsi" "&JOBSDIR;/JREGIONAL_ANALYSIS_GSI"'
    join: !cycstr '&LOGDIR;/{{ jobname }}_@Y@m@d@H&LOGEXT;'
    envars:
      <<: *default_envars
      GSI_TYPE: analysis
      MEM_TYPE: member
    dependency:
      and:
        timedep: '<cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr>'
        taskdep:
          attrs:
            task: prep_cyc_#cycle_type#




